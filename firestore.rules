rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isEventHost(eventId) {
      return isSignedIn() &&
        get(/databases/$(database)/documents/events/$(eventId)).data.hostUid == request.auth.uid;
    }

    // âœ… FIXED: Collection group rule for ratings
    match /{path=**}/startups/{startupId}/ratings/{userId} {
      allow read: if isSignedIn() && request.auth.uid == userId;
      allow write: if isSignedIn() && request.auth.uid == userId;
    }

    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;

      match /{document=**} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }

      match /eventPremoneyAccounts/{eventId} {
        allow read: if isSignedIn() && request.auth.uid == userId;
        allow create, update: if isSignedIn() && request.auth.uid == userId;
      }
    }

    match /events/{eventId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isEventHost(eventId);

      match /startups/{startupId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isEventHost(eventId);

        match /ratings/{userId} {
          // Users can only read their own ratings
          allow read: if isSignedIn() && request.auth.uid == userId;
          // Host can read all ratings in their event
          allow read: if isEventHost(eventId);
          // Users can only write their own ratings
          allow write: if isSignedIn() && request.auth.uid == userId;
        }
      }

      match /judges/{judgeId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isEventHost(eventId);
      }

      match /investors/{userId} {
        // Users can only read their own investor record
        allow read: if isSignedIn() && request.auth.uid == userId;
        // Host can read all investors in their event
        allow read: if isEventHost(eventId);
        // Users can create/update their own record
        allow create, update: if isSignedIn() && request.auth.uid == userId
        && get(/databases/$(database)/documents/events/$(eventId)).data.status == 'live';
      }

      match /ratings/{ratingId} {
        // Users can only read their own ratings
        allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
        // Host can read all ratings
        allow read: if isEventHost(eventId);
        // Users can only write their own ratings
        allow write: if isSignedIn() && request.resource.data.userId == request.auth.uid
        && get(/databases/$(database)/documents/events/$(eventId)).data.status == 'live';
      }

      match /investments/{investmentId} {
        // Users can only read their own investments
        allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
        // Host can read all investments in their event
        allow read: if isEventHost(eventId);
        // Users can create/update their own investments ONLY when event is live
        allow create, update: if isSignedIn()
          && request.resource.data.userId == request.auth.uid
          && (request.resource.data.eventId == eventId || request.resource.data.eventId == int(eventId))
          && get(/databases/$(database)/documents/events/$(eventId)).data.status == 'live';
        allow delete: if isEventHost(eventId);
      }

      match /feedback/{feedbackId} {
        // Users can only read their own feedback
        allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
        // Host can read all feedback
        allow read: if isEventHost(eventId);
        // Users can create/update their own feedback
        allow create, update: if isSignedIn()
          && request.resource.data.userId == request.auth.uid
          && (request.resource.data.eventId == eventId || request.resource.data.eventId == int(eventId));
        allow delete: if isEventHost(eventId);
      }

      match /notifications/{notifId} {
        allow read: if isSignedIn() && request.auth.uid == resource.data.userUid;
        allow create: if isSignedIn();
        allow delete: if isSignedIn() && request.auth.uid == resource.data.userUid;
      }

      // Remove the wildcard rule - be explicit instead
      // match /{document=**} {
      //   allow read: if isSignedIn();
      // }
    }
    
    // Results 
    match /events/{eventId}/results/{docId} {
        function getEvent() {
          return get(/databases/$(database)/documents/events/$(eventId));
        }
        
        function areResultsReady() {
          let event = getEvent();
          return event != null && event.data.resultsReady == true;
        }
        
        // Only authenticated users can read, and only when results are ready
        allow read: if request.auth != null && areResultsReady();
        
        // Only Cloud Functions can write
        allow write: if false;
    }

    // Bug Reports
    match /bugReports/{reportId} {
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.status == 'new';
      
      allow read: if request.auth != null 
                 && resource.data.userId == request.auth.uid;
      
      allow update: if request.auth != null 
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == resource.data.userId;
      
      allow delete: if false;
    }

  }
}